<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸš€ å®æ—¶æ¨¡æ‹Ÿäº¤æ˜“Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'pulse-slow': 'pulse 2s infinite',
                        'bounce-light': 'bounce 1s infinite',
                    },
                    colors: {
                        'trading-green': '#10b981',
                        'trading-red': '#ef4444',
                        'trading-blue': '#3b82f6',
                        'trading-purple': '#8b5cf6',
                    }
                }
            }
        }
    </script>
    <style>
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .chart-container canvas {
            background: transparent !important;
        }
        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }
        .scrollbar-thin::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-800 via-gray-900 to-gray-800 text-white min-h-screen p-2 sm:p-4 overflow-x-hidden">
    <div class="max-w-7xl mx-auto min-h-screen flex flex-col">
        <!-- Header -->
        <div class="text-center mb-6 flex-shrink-0">
            <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold mb-2 text-shadow-lg">
                ğŸš€ å®æ—¶æ¨¡æ‹Ÿäº¤æ˜“Dashboard
            </h1>
            <div class="status-indicator inline-block glass-effect px-4 py-2 rounded-full text-sm bg-yellow-500 bg-opacity-20 animate-bounce">
                ğŸ”„ è¿æ¥ä¸­...
            </div>
        </div>
        
        <!-- Activity Log -->
        <div class="glass-effect rounded-xl p-3 sm:p-4 mb-4 max-h-40 overflow-y-auto scrollbar-thin" id="activityLog">
            <div class="text-white text-opacity-70 text-xs">ç­‰å¾…æ—¥å¿—...</div>
        </div>
        
        <!-- Metrics Grid -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 sm:gap-4 mb-6 flex-shrink-0" id="metricsGrid">
            <div class="glass-effect rounded-xl p-4 text-center transition-transform hover:-translate-y-1">
                <div class="text-white text-opacity-70 text-xs sm:text-sm mb-2 uppercase tracking-wide">åŠ è½½ä¸­...</div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="flex-1 grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6 min-h-0 items-top">
            <!-- Portfolio Chart -->
            <div class="lg:col-span-1 glass-effect rounded-xl p-4 flex flex-col">
                <h3 class="text-center text-lg sm:text-xl font-semibold mb-4">ğŸ“ˆ æŠ•èµ„ç»„åˆä»·å€¼</h3>
                <div class="flex-1 relative min-h-[200px] sm:min-h-[250px] max-h-[350px]">
                    <canvas id="portfolioChart"></canvas>
                </div>
            </div>
            
            <!-- Trades Section -->
            <div class="md:col-span-1 glass-effect rounded-xl p-4 flex flex-col">
                <h3 class="text-center text-lg sm:text-xl font-semibold mb-4">ğŸ“Š æœ€è¿‘äº¤æ˜“è®°å½•</h3>
                <div class="flex-1 overflow-y-auto scrollbar-thin" id="tradesContainer">
                    <div class="text-center text-white text-opacity-70 py-8">åŠ è½½äº¤æ˜“æ•°æ®...</div>
                </div>
            </div>
        </div>
        

        
        <!-- Last Update -->
        <div class="text-center text-white text-opacity-60 text-xs mt-4 flex-shrink-0" id="lastUpdate"></div>
    </div>

    <script>
        let portfolioChart;
        let eventSource;
        let reconnectTimeout;
        let connectionStatus = 'connecting';
        
        // ç­‰å¾…Chart.jsåŠ è½½å®Œæˆ
        function waitForChart() {
            return new Promise((resolve) => {
                if (typeof Chart !== 'undefined') {
                    resolve();
                } else {
                    setTimeout(() => waitForChart().then(resolve), 100);
                }
            });
        }
        
        // åˆå§‹åŒ–å›¾è¡¨
        async function initCharts() {
            await waitForChart();
            // æŠ•èµ„ç»„åˆå›¾è¡¨
            const portfolioCtx = document.getElementById('portfolioChart').getContext('2d');
            portfolioChart = new Chart(portfolioCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'æŠ•èµ„ç»„åˆä»·å€¼ (SOL)',
                        data: [],
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 2,
                        pointHoverRadius: 4,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 300 },
                    plugins: {
                        legend: { 
                            labels: { color: '#fff', font: { size: 11 } }
                        }
                    },
                    scales: {
                        x: { 
                            ticks: { color: '#fff', font: { size: 10 } }, 
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            display: true
                        },
                        y: { 
                            ticks: { color: '#fff', font: { size: 10 } }, 
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    },
                    elements: {
                        point: { radius: 1 }
                    }
                }
            });
        }
        
        // åˆå§‹åŒ–SSEè¿æ¥
        function initSSE() {
            if (eventSource) {
                eventSource.close();
            }
            
            updateConnectionStatus('connecting');
            eventSource = new EventSource('/api/stream');
            
            eventSource.onopen = function(event) {
                console.log('âœ… SSEè¿æ¥å·²å»ºç«‹');
                updateConnectionStatus('connected');
                if (reconnectTimeout) {
                    clearTimeout(reconnectTimeout);
                    reconnectTimeout = null;
                }
            };
            
            eventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    updateMetrics(data);
                    updateCharts(data);
                    updateTrades(data);
                    updateActivityLogs(data);
                    
                    document.getElementById('lastUpdate').textContent = 
                        `æœ€åæ›´æ–°: ${new Date().toLocaleTimeString()}`;
                    // å°†æœ€æ–°æ´»åŠ¨ä¿¡æ¯æ»šåŠ¨æ˜¾ç¤ºåœ¨â€œå·²è¿æ¥â€æ ‡ç­¾ä¸Š
                    const lastLog = (data.activity_logs || []).slice(-1)[0];
                    if (connectionStatus === 'connected' && lastLog) {
                        const statusElement = document.querySelector('.status-indicator');
                        if (statusElement) {
                            statusElement.textContent = `âœ… å·²è¿æ¥ Â· ${lastLog.message}`;
                        }
                    }
                        
                } catch (error) {
                    console.error('æ•°æ®è§£æå¤±è´¥:', error);
                }
            };
            
            eventSource.onerror = function(event) {
                console.error('âŒ SSEè¿æ¥é”™è¯¯:', event);
                updateConnectionStatus('disconnected');
                
                // è‡ªåŠ¨é‡è¿æœºåˆ¶
                if (!reconnectTimeout) {
                    reconnectTimeout = setTimeout(() => {
                        console.log('ğŸ”„ å°è¯•é‡æ–°è¿æ¥...');
                        initSSE();
                    }, 3000);
                }
            };
        }
        
        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(status) {
            connectionStatus = status;
            const statusElement = document.querySelector('.status-indicator');
            if (statusElement) {
                const statusText = {
                    'connecting': 'ğŸ”„ è¿æ¥ä¸­...',
                    'connected': 'âœ… å·²è¿æ¥',
                    'disconnected': 'âŒ è¿æ¥æ–­å¼€'
                };
                statusElement.textContent = statusText[status] || 'â“ æœªçŸ¥çŠ¶æ€';
                
                // æ›´æ–°æ ·å¼
                statusElement.className = `status-indicator glass-effect px-4 py-2 rounded-full text-sm ${
                    status === 'connected' ? 'bg-trading-green bg-opacity-20 animate-pulse-slow' :
                    status === 'connecting' ? 'bg-yellow-500 bg-opacity-20 animate-bounce' :
                    'bg-trading-red bg-opacity-20'
                }`;
            }
        }
        
        // æ›´æ–°æ´»åŠ¨æ—¥å¿—
        function updateActivityLogs(data) {
            const logs = data.activity_logs || [];
            const container = document.getElementById('activityLog');
            if (!container) return;
            if (logs.length === 0) {
                container.innerHTML = '<div class="text-white text-opacity-70 text-xs">æš‚æ— æ—¥å¿—</div>';
                return;
            }
            const typeColor = (t) => (
                t === 'success' ? 'text-trading-green' :
                t === 'warning' ? 'text-yellow-300' :
                t === 'error' ? 'text-trading-red' : 'text-white'
            );
            const typeIcon = (t) => (
                t === 'success' ? 'âœ…' :
                t === 'warning' ? 'âš ï¸' :
                t === 'error' ? 'âŒ' : 'â„¹ï¸'
            );
            const items = logs.slice(-50).map(l => `
                <div class="flex items-start gap-2 py-1">
                    <span class="flex-shrink-0">${typeIcon(l.type)}</span>
                    <div class="flex-1 text-xs sm:text-sm ${typeColor(l.type)}">
                        <span class="text-white text-opacity-40 mr-2">${new Date(l.timestamp).toLocaleTimeString().slice(0,8)}</span>
                        <span>${l.message}</span>
                    </div>
                </div>
            `).join('');
            const atBottom = Math.abs((container.scrollTop + container.clientHeight) - container.scrollHeight) < 8;
            container.innerHTML = items;
            if (atBottom) {
                container.scrollTop = container.scrollHeight;
            }
        }
        
        // æ›´æ–°æŒ‡æ ‡å¡ç‰‡
        function updateMetrics(data) {
            const { summary, stats } = data;
            
            document.getElementById('metricsGrid').innerHTML = `
                <div class="glass-effect rounded-xl p-4 text-center transition-transform hover:-translate-y-1">
                    <h3 class="text-white text-opacity-70 text-xs sm:text-sm mb-2 uppercase tracking-wide">æŠ•èµ„ç»„åˆä»·å€¼</h3>
                    <div class="text-xl sm:text-2xl font-bold mb-1">${summary.portfolio_value.toFixed(4)} SOL</div>
                    <div class="text-xs sm:text-sm ${summary.total_return_pct >= 0 ? 'text-trading-green' : 'text-trading-red'}">
                        ${summary.total_return_pct >= 0 ? '+' : ''}${summary.total_return_pct.toFixed(2)}%
                    </div>
                </div>
                <div class="glass-effect rounded-xl p-4 text-center transition-transform hover:-translate-y-1">
                    <h3 class="text-white text-opacity-70 text-xs sm:text-sm mb-2 uppercase tracking-wide">å¯ç”¨ä½™é¢</h3>
                    <div class="text-xl sm:text-2xl font-bold mb-1">${summary.current_balance.toFixed(4)} SOL</div>
                    <div class="text-xs sm:text-sm text-white text-opacity-70">åˆå§‹: ${summary.initial_balance.toFixed(1)} SOL</div>
                </div>
                <div class="glass-effect rounded-xl p-4 text-center transition-transform hover:-translate-y-1">
                    <h3 class="text-white text-opacity-70 text-xs sm:text-sm mb-2 uppercase tracking-wide">èƒœç‡</h3>
                    <div class="text-xl sm:text-2xl font-bold mb-1">${stats.win_rate.toFixed(1)}%</div>
                    <div class="text-xs sm:text-sm text-white text-opacity-70">${stats.winning_trades}èƒœ / ${stats.losing_trades}è´Ÿ</div>
                </div>
                <div class="glass-effect rounded-xl p-4 text-center transition-transform hover:-translate-y-1">
                    <h3 class="text-white text-opacity-70 text-xs sm:text-sm mb-2 uppercase tracking-wide">æ€»äº¤æ˜“æ•°</h3>
                    <div class="text-xl sm:text-2xl font-bold mb-1">${summary.total_trades}</div>
                    <div class="text-xs sm:text-sm text-white text-opacity-70">æ´»è·ƒ: ${stats.active_positions}</div>
                </div>
            `;
        }
        
        // æ›´æ–°å›¾è¡¨
        function updateCharts(data) {
            // æ›´æ–°æŠ•èµ„ç»„åˆå›¾è¡¨
            const history = data.portfolio_history || [];
            const maxPoints = 20; // é™åˆ¶æ˜¾ç¤ºç‚¹æ•°
            const recentHistory = history.slice(-maxPoints);
            
            portfolioChart.data.labels = recentHistory.map(h => 
                new Date(h.timestamp).toLocaleTimeString().slice(0, 5)
            );
            portfolioChart.data.datasets[0].data = recentHistory.map(h => h.value);
            portfolioChart.update('none');
        }
        
        // æ›´æ–°äº¤æ˜“è®°å½•
        function updateTrades(data) {
            const trades = data.recent_trades || [];
            const container = document.getElementById('tradesContainer');
            
            if (trades.length === 0) {
                container.innerHTML = '<div class="text-center text-white text-opacity-70 py-8">æš‚æ— äº¤æ˜“è®°å½•</div>';
                return;
            }
            
            // åªæ˜¾ç¤ºæœ€è¿‘15æ¡è®°å½•
            const recentTrades = trades.slice(0, 15);
            
            container.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-white border-opacity-20">
                                <th class="text-left text-white text-opacity-70 text-xs sm:text-sm font-semibold py-2 px-2 sm:px-3">æ—¶é—´</th>
                                <th class="text-left text-white text-opacity-70 text-xs sm:text-sm font-semibold py-2 px-2 sm:px-3">ä»£å¸</th>
                                <th class="text-left text-white text-opacity-70 text-xs sm:text-sm font-semibold py-2 px-2 sm:px-3">æ“ä½œ</th>
                                <th class="text-left text-white text-opacity-70 text-xs sm:text-sm font-semibold py-2 px-2 sm:px-3">ä»·æ ¼</th>
                                <th class="text-left text-white text-opacity-70 text-xs sm:text-sm font-semibold py-2 px-2 sm:px-3">ç›ˆäº</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-white divide-opacity-10">
                            ${recentTrades.map(trade => `
                                <tr class="hover:bg-white hover:bg-opacity-5 transition-colors">
                                    <td class="text-xs sm:text-sm py-2 px-2 sm:px-3">${new Date(trade.timestamp).toLocaleTimeString().slice(0, 5)}</td>
                                    <td class="text-xs sm:text-sm py-2 px-2 sm:px-3 font-medium">${trade.symbol}</td>
                                    <td class="text-xs sm:text-sm py-2 px-2 sm:px-3 font-semibold ${trade.action === 'buy' ? 'text-trading-green' : 'text-orange-400'}">${trade.action === 'buy' ? 'ä¹°å…¥' : 'å–å‡º'}</td>
                                    <td class="text-xs sm:text-sm py-2 px-2 sm:px-3 font-mono">${trade.price.toExponential(2)}</td>
                                    <td class="text-xs sm:text-sm py-2 px-2 sm:px-3 font-semibold ${trade.pnl_pct ? (trade.pnl_pct >= 0 ? 'text-trading-green' : 'text-trading-red') : 'text-white text-opacity-50'}">
                                        ${trade.pnl_pct ? (trade.pnl_pct >= 0 ? '+' : '') + trade.pnl_pct.toFixed(1) + '%' : '-'}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        // æ¸…ç†è¿æ¥
        function cleanup() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
            if (reconnectTimeout) {
                clearTimeout(reconnectTimeout);
                reconnectTimeout = null;
            }
        }
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                await initCharts();
                initSSE();
                
                console.log('ğŸš€ Dashboardåˆå§‹åŒ–å®Œæˆï¼Œä½¿ç”¨SSEå®æ—¶æ›´æ–°');
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                document.getElementById('lastUpdate').textContent = 'åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢';
                updateConnectionStatus('disconnected');
            }
        });
        
        // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶å¤„ç†SSEè¿æ¥
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                console.log('â¸ï¸ é¡µé¢éšè—ï¼Œæš‚åœSSEè¿æ¥');
                cleanup();
            } else {
                console.log('â–¶ï¸ é¡µé¢æ¢å¤ï¼Œé‡æ–°å»ºç«‹SSEè¿æ¥');
                initSSE();
            }
        });
        
        // é¡µé¢å¸è½½æ—¶æ¸…ç†è¿æ¥
        window.addEventListener('beforeunload', cleanup);
    </script>
</body>
</html>